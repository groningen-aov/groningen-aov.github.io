<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Cases - Groningen AOV Calculator</title>
    <meta
      name="description"
      content="Validation test cases for the Groningen AOV Calculator"
    />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2060df" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="AOV Test" />

    <!-- Pico.css Blue Theme -->
    <link rel="stylesheet" href="../style/pico.blue.min.css" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../style/style.css" />

    <link rel="manifest" href="../manifest.json" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="container-fluid">
      <ul>
        <li><a href="/" class="secondary">Home</a></li>
        <li><a href="/about/" class="secondary">About</a></li>
        <li><a href="/test/" class="secondary">Test</a></li>
        <li>
          <div class="status">
            <span class="status-indicator" id="status-indicator" style="color: var(--pico-primary);">●</span>
            <span>Ready</span>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Main container -->
    <main class="container">
      <!-- Header -->
      <header>
        <hgroup>
          <h1>Validation Test Cases</h1>
          <p>
            Verify calculator accuracy against validated reference values from the interpolated R model
          </p>
        </hgroup>
      </header>

      <!-- Test Controls -->
      <section>
        <article>
          <header>
            <h2>Model Validation</h2>
          </header>
          
          <p>
            These test cases validate the JavaScript implementation against the interpolated 
            Groningen GAM model. The interpolated model approximates the original GAM with 
            &lt;0.5% relative error while providing fast calculations. All JavaScript results 
            should match interpolated values within 0.001 tolerance.
          </p>

          <div style="text-align: center; margin: 2rem 0;">
            <button type="button" class="primary" id="runTestsBtn" onclick="runAllTests()">
              Run All Test Cases
            </button>
            <button type="button" class="outline" id="clearResultsBtn" onclick="clearResults()">
              Clear Results
            </button>
          </div>

          <!-- Test Status -->
          <div id="testStatus" style="display: none; text-align: center; margin: 1rem 0;">
            <progress id="testProgress"></progress>
            <p id="testStatusText">Running tests...</p>
          </div>

          <!-- Test Summary -->
          <div id="testSummary" style="display: none;">
            <!-- Will be populated with results -->
          </div>
        </article>
      </section>

      <!-- Test Results -->
      <section>
        <article>
          <header>
            <h2>Test Results</h2>
          </header>

          <div id="testResults">
            <p style="text-align: center; color: var(--pico-muted-color); font-style: italic;">
              Click "Run All Test Cases" to validate the calculator
            </p>
          </div>
        </article>
      </section>

      <!-- Reference Test Cases -->
      <section>
        <article>
          <header>
            <h2>Reference Test Cases</h2>
          </header>
          
          <p>The following validated test cases span the full range of model inputs:</p>

          <div style="overflow-x: auto;">
            <table class="striped">
              <thead>
                <tr>
                  <th>Case</th>
                  <th>Age</th>
                  <th>Sex</th>
                  <th>Weight (kg)</th>
                  <th>Height (cm)</th>
                  <th>Expected AAD (mm)</th>
                  <th>Expected SD (mm)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Newborn Male</td>
                  <td>≈1 day</td>
                  <td>Male</td>
                  <td>3.5</td>
                  <td>50</td>
                  <td>6.221</td>
                  <td>0.932</td>
                </tr>
                <tr>
                  <td>Infant Female</td>
                  <td>1 year</td>
                  <td>Female</td>
                  <td>10.0</td>
                  <td>75</td>
                  <td>10.069</td>
                  <td>1.030</td>
                </tr>
                <tr>
                  <td>Toddler Male</td>
                  <td>3 years</td>
                  <td>Male</td>
                  <td>15.0</td>
                  <td>95</td>
                  <td>12.380</td>
                  <td>1.205</td>
                </tr>
                <tr>
                  <td>School-age Female</td>
                  <td>8 years</td>
                  <td>Female</td>
                  <td>25.0</td>
                  <td>125</td>
                  <td>14.285</td>
                  <td>1.358</td>
                </tr>
                <tr>
                  <td>Adolescent Male</td>
                  <td>15 years</td>
                  <td>Male</td>
                  <td>55.0</td>
                  <td>165</td>
                  <td>18.982</td>
                  <td>1.728</td>
                </tr>
                <tr>
                  <td>Young Adult Female</td>
                  <td>25 years</td>
                  <td>Female</td>
                  <td>60.0</td>
                  <td>162</td>
                  <td>19.564</td>
                  <td>1.673</td>
                </tr>
                <tr>
                  <td>Middle-aged Male</td>
                  <td>40 years</td>
                  <td>Male</td>
                  <td>80.0</td>
                  <td>175</td>
                  <td>23.420</td>
                  <td>1.745</td>
                </tr>
                <tr>
                  <td>Large Adult Male</td>
                  <td>35 years</td>
                  <td>Male</td>
                  <td>120.0</td>
                  <td>185</td>
                  <td>24.432</td>
                  <td>1.824</td>
                </tr>
                <tr>
                  <td>Small Adult Female</td>
                  <td>50 years</td>
                  <td>Female</td>
                  <td>45.0</td>
                  <td>150</td>
                  <td>20.435</td>
                  <td>1.658</td>
                </tr>
                <tr>
                  <td>Very Large Male</td>
                  <td>45 years</td>
                  <td>Male</td>
                  <td>150.0</td>
                  <td>190</td>
                  <td>26.074</td>
                  <td>1.873</td>
                </tr>
              </tbody>
            </table>
          </div>

          <p style="margin-top: 1rem;">
            <small>
              <strong>Note:</strong> Expected values are from the validated interpolated R model.
              JavaScript results should match within ±0.001 tolerance. The interpolated model 
              approximates the original GAM with excellent accuracy (&lt;0.5% relative error).
            </small>
          </p>
        </article>
      </section>

      <!-- Quick Test Links -->
      <section>
        <article>
          <header>
            <h2>Quick Test Links</h2>
          </header>
          
          <p>Click these links to test specific cases in the calculator:</p>

          <div style="display: grid; gap: 0.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            <a href="/results/?sex=male&age=1&ageUnit=days&height=50&weight=3.5&units=metric" class="secondary" role="button">
              Newborn Male (≈1d, 3.5kg, 50cm)
            </a>
            <a href="/results/?sex=female&age=1&ageUnit=years&height=75&weight=10&units=metric" class="secondary" role="button">
              Infant Female (1y, 10kg, 75cm)
            </a>
            <a href="/results/?sex=male&age=3&ageUnit=years&height=95&weight=15&units=metric" class="secondary" role="button">
              Toddler Male (3y, 15kg, 95cm)
            </a>
            <a href="/results/?sex=female&age=8&ageUnit=years&height=125&weight=25&units=metric" class="secondary" role="button">
              School-age Female (8y, 25kg, 125cm)
            </a>
            <a href="/results/?sex=male&age=15&ageUnit=years&height=165&weight=55&units=metric" class="secondary" role="button">
              Adolescent Male (15y, 55kg, 165cm)
            </a>
            <a href="/results/?sex=male&age=45&ageUnit=years&height=190&weight=150&units=metric" class="secondary" role="button">
              Very Large Male (45y, 150kg, 190cm)
            </a>
          </div>
        </article>
      </section>

      <!-- Model Information -->
      <section>
        <article>
          <header>
            <h2>Model Information</h2>
          </header>
          
          <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            <div style="padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
              <h4>Interpolation Accuracy</h4>
              <p>
                <strong>Mean error:</strong> &lt;0.05mm (0.3% relative)<br>
                <strong>Max error:</strong> 0.12mm (0.57% relative)<br>
                <strong>All cases:</strong> &lt;1% relative error
              </p>
            </div>
            
            <div style="padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
              <h4>Clinical Coverage</h4>
              <p>
                <strong>Age range:</strong> 1 day to 50 years<br>
                <strong>Weight range:</strong> 3.5kg to 150kg<br>
                <strong>Height range:</strong> 50cm to 190cm
              </p>
            </div>
          </div>
          
          <p style="margin-top: 1rem;">
            <small>
              The interpolated grid model provides fast, accurate predictions while maintaining 
              excellent fidelity to the original Groningen GAM. For research applications requiring 
              maximum precision, consider using the original R GAM model directly.
            </small>
          </p>
        </article>
      </section>
    </main>

    <!-- Footer -->
    <footer class="container">
      <small>
        <p>
          <em>For clinical decision support only. Always verify with institutional protocols.</em>
        </p>
      </small>
    </footer>

    <!-- Scripts -->
    <script src="../js/results-calculator.js"></script>
    <script src="../js/version.js"></script>

    <script>
      // Test cases matching the validated interpolated R model
      const testCases = [
        {
          name: "Newborn Male",
          age: 0.003,      // ≈1 day old - FIXED from age 0
          sex: "male",
          weight: 3.5,
          height: 50,
          expectedAAD: 6.2213,   // Updated interpolated value
          expectedSD: 0.9324,    // Updated interpolated value
          canonicalAAD: 6.1990,  // Original GAM (for reference)
          canonicalSD: 0.9340    // Original GAM (for reference)
        },
        {
          name: "Infant Female", 
          age: 1,
          sex: "female",
          weight: 10.0,
          height: 75,
          expectedAAD: 10.0688,
          expectedSD: 1.0299,
          canonicalAAD: 10.0416,
          canonicalSD: 1.0299
        },
        {
          name: "Toddler Male",
          age: 3,
          sex: "male", 
          weight: 15.0,
          height: 95,
          expectedAAD: 12.3796,
          expectedSD: 1.2051,
          canonicalAAD: 12.3457,
          canonicalSD: 1.2023
        },
        {
          name: "School-age Female",
          age: 8,
          sex: "female",
          weight: 25.0,
          height: 125,
          expectedAAD: 14.2851,
          expectedSD: 1.3582,
          canonicalAAD: 14.2405,
          canonicalSD: 1.3575
        },
        {
          name: "Adolescent Male",
          age: 15,
          sex: "male",
          weight: 55.0,
          height: 165,
          expectedAAD: 18.9819,
          expectedSD: 1.7277,
          canonicalAAD: 18.9601,
          canonicalSD: 1.7242
        },
        {
          name: "Young Adult Female",
          age: 25,
          sex: "female",
          weight: 60.0,
          height: 162,
          expectedAAD: 19.5638,
          expectedSD: 1.6732,
          canonicalAAD: 19.6336,
          canonicalSD: 1.6731
        },
        {
          name: "Middle-aged Male",
          age: 40,
          sex: "male",
          weight: 80.0,
          height: 175,
          expectedAAD: 23.4203,
          expectedSD: 1.7446,
          canonicalAAD: 23.4241,
          canonicalSD: 1.7285
        },
        {
          name: "Large Adult Male",
          age: 35,
          sex: "male",
          weight: 120.0,
          height: 185,
          expectedAAD: 24.4319,
          expectedSD: 1.8236,
          canonicalAAD: 24.3884,
          canonicalSD: 1.8113
        },
        {
          name: "Small Adult Female",
          age: 50,
          sex: "female",
          weight: 45.0,
          height: 150,
          expectedAAD: 20.4350,
          expectedSD: 1.6576,
          canonicalAAD: 20.3198,
          canonicalSD: 1.6570
        },
        {
          name: "Very Large Male",
          age: 45,
          sex: "male",
          weight: 150.0,
          height: 190,
          expectedAAD: 26.0737,
          expectedSD: 1.8730,
          canonicalAAD: 25.9667,
          canonicalSD: 1.8569
        }
      ];

      let calculator = null;

      // Initialize calculator
      async function initCalculator() {
        if (!calculator) {
          calculator = new ResultsCalculator();
          await calculator.loadModel();
        }
        return calculator;
      }

      // Run all test cases
      async function runAllTests() {
        const runButton = document.getElementById('runTestsBtn');
        const testStatus = document.getElementById('testStatus');
        const testProgress = document.getElementById('testProgress');
        const testStatusText = document.getElementById('testStatusText');
        const testResults = document.getElementById('testResults');
        const testSummary = document.getElementById('testSummary');

        // Show progress
        runButton.disabled = true;
        testStatus.style.display = 'block';
        testProgress.value = 0;
        testResults.innerHTML = '';
        testSummary.style.display = 'none';

        try {
          // Initialize calculator
          testStatusText.textContent = 'Loading model...';
          await initCalculator();

          let passed = 0;
          let failed = 0;
          const tolerance = 0.001;
          const results = [];

          // Run each test case
          for (let i = 0; i < testCases.length; i++) {
            const testCase = testCases[i];
            testStatusText.textContent = `Testing ${testCase.name} (${i + 1}/${testCases.length})...`;
            testProgress.value = (i / testCases.length) * 100;

            try {
              const result = calculator.calculateResults(
                testCase.age,
                testCase.weight,
                testCase.height,
                testCase.sex
              );

              const aadError = Math.abs(result.meanAAD - testCase.expectedAAD);
              const sdError = Math.abs(result.stdDev - testCase.expectedSD);
              const aadPass = aadError <= tolerance;
              const sdPass = sdError <= tolerance;
              const testPass = aadPass && sdPass;

              if (testPass) passed++;
              else failed++;

              results.push({
                testCase,
                result,
                aadError,
                sdError,
                testPass
              });

            } catch (error) {
              failed++;
              results.push({
                testCase,
                error: error.message,
                testPass: false
              });
            }

            // Small delay to show progress
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          // Show results
          testProgress.value = 100;
          testStatusText.textContent = 'Tests completed!';
          
          displayTestResults(results, passed, failed, tolerance);
          
        } catch (error) {
          testStatusText.textContent = 'Test failed: ' + error.message;
          testResults.innerHTML = `<p style="color: var(--pico-del-color);">Failed to run tests: ${error.message}</p>`;
        } finally {
          runButton.disabled = false;
          setTimeout(() => {
            testStatus.style.display = 'none';
          }, 2000);
        }
      }

      // Display test results
      function displayTestResults(results, passed, failed, tolerance) {
        const testResults = document.getElementById('testResults');
        const testSummary = document.getElementById('testSummary');

        // Summary
        const passRate = (passed / (passed + failed) * 100).toFixed(1);
        
        testSummary.innerHTML = `
          <div style="background: var(--pico-${failed === 0 ? 'ins' : 'del'}-background-color); 
                      color: var(--pico-${failed === 0 ? 'ins' : 'del'}-color); 
                      padding: 1rem; 
                      border-radius: var(--pico-border-radius); 
                      text-align: center;">
            <strong>Test Results: ${passed} passed, ${failed} failed (${passRate}% pass rate)</strong>
            <br>
            <small>Tolerance: ±${tolerance} mm | Validated against interpolated R model</small>
          </div>
        `;
        testSummary.style.display = 'block';

        // Detailed results
        let html = '<div style="overflow-x: auto;"><table class="striped"><thead><tr>';
        html += '<th>Test Case</th><th>Expected AAD</th><th>Actual AAD</th><th>AAD Error</th>';
        html += '<th>Expected SD</th><th>Actual SD</th><th>SD Error</th><th>Result</th>';
        html += '</tr></thead><tbody>';

        results.forEach(result => {
          const statusIcon = result.testPass ? '✅' : '❌';
          
          if (result.error) {
            html += `<tr><td>${result.testCase.name}</td><td colspan="6">Error: ${result.error}</td><td>${statusIcon}</td></tr>`;
          } else {
            html += `<tr style="background-color: ${result.testPass ? 'var(--pico-ins-background-color)' : 'var(--pico-del-background-color)'};">`;
            html += `<td><strong>${result.testCase.name}</strong></td>`;
            html += `<td>${result.testCase.expectedAAD.toFixed(3)}</td>`;
            html += `<td>${result.result.meanAAD.toFixed(3)}</td>`;
            html += `<td>${result.aadError.toFixed(4)}</td>`;
            html += `<td>${result.testCase.expectedSD.toFixed(3)}</td>`;
            html += `<td>${result.result.stdDev.toFixed(3)}</td>`;
            html += `<td>${result.sdError.toFixed(4)}</td>`;
            html += `<td>${statusIcon}</td>`;
            html += '</tr>';
          }
        });

        html += '</tbody></table></div>';
        testResults.innerHTML = html;
      }

      // Clear results
      function clearResults() {
        document.getElementById('testResults').innerHTML = `
          <p style="text-align: center; color: var(--pico-muted-color); font-style: italic;">
            Click "Run All Test Cases" to validate the calculator
          </p>
        `;
        document.getElementById('testSummary').style.display = 'none';
      }

      // Update status indicator when model loads
      async function updateStatus() {
        try {
          await initCalculator();
          document.getElementById('statusIndicator').style.color = '#28a745';
          document.getElementById('statusText').textContent = 'Model Ready';
        } catch (error) {
          document.getElementById('statusIndicator').style.color = '#dc3545';
          document.getElementById('statusText').textContent = 'Model Load Failed';
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
        updateStatus();
      });
    </script>
  </body>
</html>